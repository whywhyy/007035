# 1장. 모놀리식 지옥에서 벗어나라

## 1.1 서서히 모놀리식 지옥에 빠져들다.

> 처음 개발할때는 모놀리식 방식이 맞았으나 서비스가 커지면서 맞지 않게 되었음

- 규모가 작았던 모놀리식 아키텍처 장점
  - 개발이 간단함
  - 애플리케이션을 쉽게 변경함
  - 테스트하기 쉽다
  - 배포하기 쉽다.
  - 확장하기 쉽다.

> 하나의 코드베이스에 여러팀이 여러기능을 개발하다보니, 기능별 브랜치로 진행해도 매번 merge 할때마다 개발자를 괴롭힘! 확장에 주눅들게 됨!

- 문제점 (관리성, 확장성, 테스트성)
    - IDE 가 무거워짐, 빌드시간 김, 실행시간 김, 테스트도 김;;
    - 커밋부터 배포까지 너무 긴 여정
      - 테스트 시간이 너무 김(너부 변경이 많아서 확인할게 많음)
      - 코드베이스가 너무 복잡하여 변경 영향도가 제대로 파악이 안됨. 모든 테스트를 동작시켜 원인찾고 해결하는데 오래걸림
    - 확장하기 어려움
      - 기능이 여러개다보니 다 충족하는 서버리소스 배분 파악이 어려움
    - 모놀리스는 확실하게 전달하기 어려움
      - 격리되어 있는 상황이 아니라서 하나만 에러나도 다 내려야됨 ㅠㅠ
    - 기술 스택 변경 어려움
      - 상위 릴리즈에서 호환해주지 않는다면 상위호환으로 옮기기에 리스크가 크다.

 ## 무엇을 배우게 되는가
 - 마이크로 서비스 특징 및 장단점, 사용시점
 - 분산 데이터 관리 패턴
 - 효과적인 마이크로서비스 테스트 전략
 - 마이크로서비스 배포 옵션
 - 모놀리식 아키텍처를 마이크로 아키텍처로 리팩터링 하는 전략

 ### 그래서 할 수 있게 되는 일
  - 마이크로서비스 아키텍처 패턴으로 애플리케이션 아키턱쳐링
  - 서비스 비지니스 로직을 개발
  - 사가를 이용하여 서비스간 테이터 일관성 유지
  - 여러 서비스에 걸친 쿼리를 구현
  - 마이크로 서비스를 효율적으로 테스트  
  - 안전하고, 구성 가능하고, 관측 가능한 프로덕션 레디 서비스 개발
  - 기존 모놀리식 애플리케이션을 마이크로 서비스로 리팩터링


## 모놀리식 지옥은 늦출 수는 있으나 피할 수는 없다.
 - 모놀리식 지옥은 모듈화, 자동화 테스트를 해서 늦출 수 있있으나 피할 수는 없다.

## 마이크로 서비스 특징
- 모듈성을 갖고 있다. API 경계로 모듈성 유지
- 서비스 마다 DB가 따로있다. 다른 서비스가 DB 락을 획득하여 내 서비스를 블로킹 하는 일이 없어짐.

## SOA VS 마이크로 서비스
 - 서비스간 통신 
   - SOA : SOAP, WP 표준처럼 무서운 프로토콜, 서비스 버스중심의 스마트 파이프(smart pip)를 통해 통신
   - 마이크로 서비스 : 메시지 브로커나 REST, gRPC 같은 가벼운 프로토콜로 덤(dump pipe)를 통해 통신
- 데이터
  - SOA : 전역데이터 모델 및 공유 DB
  - 마이트로 서비스: 서비스 개별 데이터 모델 및 DB
- SOA : 모놀리식 애플리케이션, 덩치큰 몇개의 서비스
- 마이크로서비스: 소규모 서비스, 수십~수백 개의 서비스

## 주의점 : 잘못 분해하는경우 분산 모놀리스를 생산해 낼 수도 있다;;
  - 잘못하면 반드시 함께 배포해야하는 결합도 높은 서비스로 이루어진 시스템이 될 수도 있으니, 잘 판단하자.

### 여러서비스 그래서 
  - 여러 서비스 마다 DB가 있음 
     - 다중 DB 접속, 조회, 트랜젝션을 구현하는 일은 어려움
     - 사가 라는 기술로 서비스간 데이터 일관성 유지
    
## 패턴
  - 적용되는 맥락을 반드시 기술해야 한다는 점에서 가치가 큼.
  - 상용 패턴은 세 부분으로 구성됨
    - 강제조항
      - 문제를 해결할때 반드시 처리해야할 강제조항임.
      - 모든 조항을 상충 할 수는 없으니, 어느 조항이 더 중요한지 우선순위를 정해야함.
      - 장점 : 어느 이슈를 해결해야할지 명확해짐
    - 결과 맥락
      - 장점 : (해결된 강제조항) 패턴의 좋은점
      - 단점 : (미해결 조항)패턴의 나쁜점
      - 이슈 : 패턴 적용시 발생하는 새로운 문제점

## 연관패턴 - 한 패턴과 다른패턴의 관계를 기술 (5가지)
 - 선행자
   - 이 패턴이 필요하게된 선행패턴
   - 마이크로 서비스아키텍처는 모놀리식 아키패턴을 제외한 나머지 패턴들의 선행자임.
   - 
 - 후행자
   - 이 패턴으로 야기된 이슈를 해결하는 패턴
   - 마이크로서비스 아키텍처 패턴을 적용하려면, 서비스 디스커버리 패턴, 회로 차단기 패턴 등을 함께 적용해야함
 - 대안
   - 이 패턴의 대체 솔루션을 제공하는 패턴
   - 모놀리식 아키텍처 패턴과 마이크로 아키텍처 패턴은 서로 대신할 수 있는 애플리케이션 아키텍처임. 둘 중 하나를 선택하면 됨.
 - 일반화
   - 문제를 해결하는 일반적인 솔루션에 해당하는 패턴
 - 세분화
   - 특정 패턴을 더 세부적으로 나타낸 형태

## 마이크로 서비스 아키텍처 패턴 개요
  - 마이크로서비스 아캐텍처 사용시 각종 이슈를 해결하는 솔루션 패턴 그룹

---
    - 3계층이 존재
      - 인프라 패턴 : 개발 영역 밖 인프라 문제해결
      - 애플리케이션 인프라 : 개발에도 영향을 미치는 인프라 문제 해결
      - 애플리케이션 패턴 : 개발자가 맞닥뜨리는 문제를 해결

---
- 어플리케인션을 분해하는 패턴
  - 비지니스 능력에 따라 분해
  - DDD 하위 도메인에 따라 서비스 구성
- 통신패턴 (5개의 그룹)
  - 통신 스타일 
    - 메시징
    - 원격 프로시저 호출
    - 도메인에 특정한
  - 디스커버리
    - 클라이언트쪽 디스커버리/ 서버쪽 디스커버리 --->
    - ----> 서비스 레지스트리 --->
    - ---> 자가등록 / 서드파티등록
  - 신뢰성
    - 회로 차단기
  - 트랜잭셔널 메세징
    - 트랜잭셔널 아웃박스
       - 폴링 발행기
       - 트랜잭션 로그 테일링
  - 외부 API
     - API 게이트웨이
     - 프론트엔드를 위한 백엔드
- 트랜잭션 관리를 위한 데이터 일관성 패턴
  - 사가 패턴 -->
  - --> 도메인 이벤트/ 애그리거트 
  - 도메인 이벤트 -> 이번트소싱 -> 애그리거트
- 데이터 쿼리 패턴
  - API 조합
  - CQRS
- 서비스 배포 패턴
- 관측성 패턴: 애플리케인션 동작파악
  - 헬스체크 API
  - 로그 수집
  - 예외 추적
  - 애플리케이션 지표
  - 감사 로깅
- 서비스 테스트 자동화 패턴
  - 컨슈머 주도 계약 테스트
  - 컨슈머 쪽 계약 테스트
  - 서비스 컴포넌트 테스트
- 횡단 관심사 처리 패턴
- 보안 패턴
    
## 마이크로 서비스만 중요한게 아니다. - 프로세스와 조직
 - 마이크로 서비스 아키텍처 --> 프로세스(데브옵스/지속적전달/배포)
 - 마이크로 서비스 아키텍처 --> 조직(작고,자율적이고,범기능적인 팀)
 - 조직 (작고,자율적이고,범기능적인 팀) --> 프로세스(데브옵스/지속적전달/배포)

 ### 맨먼스 미신 : N 인 팀의 소통 오버헤드 N<sup>2</sup>
  - 범기능적 팀을 구성하여 하나이상의 서비스를 개발/운영 하자.
    - 서비스를 독자적으로 개발, 테스트, 배포 할 수 있다.

### 조직
 - 개발 조직도 확장성이 좋아짐.
 - 팀하나가 너무 커지면 연관된 서비스 단위로 다시 팀을 나누면 됨
 - 팀은 서로 느슨하게 결합
 - 팀간 소통 오버헤드가 발생할일 없으며, 생산성에 영향을 끼치지 않고 인원을 보강할 수 있음.

 ### 소프트웨어 개발/전달 프로세스
  - 폭포수 개발 프로세스로 마이크로 서비스 아키텍처를 구축하는것은 말이 페라리를 끌고가는 모양새!
  - 애자일 개발 프로세스 도입 
    - 스크럼, 칸반 등을 실천!
  - 데브옵스의 일부인 지속적인 전달/베포를 실천하자!

#### 지속적인 전달
   - 새 기능, 구성 변경, 버그 조치, 시험 등 갖가지 변경분을 프로덕션 또는 사용자에게 직접 안전하고 신속하게, 일정 수준으로 계속 전달하는 능력
     - 언제라도 릴리즈 할 수 있는 능력
   - 자동화된 테스트, 높은수준의 자동화는 필수
   - 릴리스 가능한 코드를 프로덕션에 자동 배포하는 것
   - 평가 네가지 잣대
     - 배포 빈도
     - 리드 타임
     - 평균 복구 시간
     - 변경분 실패율

## 마이크로서비스를 받아들이는 인간적 요소
- 마이크로 서비스를 도입하면 아키텍처, 조직, 개발 프로세스가 모두 변화함.
- 즉, 근무 환경도 달라짐, 팀원들의 감정도 잘 살펴야함.
- 다음과 같은 단계를 거친다고 함.
  - 1. 끝나다, 빼앗기다, 놓아주다.
     - 예전대로 하고싶으나 못하니 분통터짐, 저항하게됨. 예전 팀동료를 그리워하게됨. 데이터 모델러는 각 서비스별 모델을 보유한다는 발상 자체에 위협을 느낌
  - 2. 중립 지대 
     - 옛 작업 방식과 새 작업 방식 사이의 중간단계, 아직도 사람들은 혼란스러워 하지만 어떻게든 새로운 방식을 배우고자 노력함.
  - 3. 새 출발
     - 사람들이 새로운 방식을 열심히 받아들이고, 그 혜택을 몸소 경험하기 시작하는 최종 단계임.

---

## 느낀점

 마이크로 서비스 아키텍처는 단지 어떠한 관점이고 하나의 개발방법론? 정도로 생각했다.

 하지만, 조직 전체를 다 바꾸고, 근무환경도 다 바꿔버리는 놀라운 녀석이다.

 마이크로 서비스 아키텍처를 도입하기위한 여러 패턴들이 이미 다 정립되어 있다. 

 MSA 를 강조하는 이유를 알겠다.